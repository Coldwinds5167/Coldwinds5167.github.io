<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="冷风喧嚣" href="https://www.coldwinds.top/rss.xml"><link rel="alternate" type="application/atom+xml" title="冷风喧嚣" href="https://www.coldwinds.top/atom.xml"><link rel="alternate" type="application/json" title="冷风喧嚣" href="https://www.coldwinds.top/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><meta name="keywords" content="pwn,IO_FILE"><link rel="canonical" href="https://www.coldwinds.top/2021/12/IO-FILE-vtable/"><title>IO_FILE介绍及vtable劫持 | Coldwinds = 冷风喧嚣 = 懒狗一只</title><meta name="generator" content="Hexo 5.4.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">IO_FILE介绍及vtable劫持</h1><div class="meta"><span class="item" title="创建时间：2021-12-13 17:05:03"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2021-12-13T17:05:03+08:00">2021-12-13</time> </span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">本文字数</span> <span>11k</span> <span class="text">字</span> </span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">阅读时长</span> <span>10 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">Coldwinds</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://tva2.sinaimg.cn/large/6833939bly1gipeu1usa7j20zk0m8b29.jpg"></li><li class="item" data-background-image="https://tva2.sinaimg.cn/large/6833939bly1gicm0fdw5cj20zk0m8hdt.jpg"></li><li class="item" data-background-image="https://tva2.sinaimg.cn/large/6833939bly1giciusoyjnj219g0u0x56.jpg"></li><li class="item" data-background-image="https://tva2.sinaimg.cn/large/6833939bly1gipeybxm1pj20zk0m8niv.jpg"></li><li class="item" data-background-image="https://tva2.sinaimg.cn/large/6833939bly1gicliierfjj20zk0m8npd.jpg"></li><li class="item" data-background-image="https://tva2.sinaimg.cn/large/6833939bly1gicis3attqj20zk0m8k7l.jpg"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.coldwinds.top/2021/12/IO-FILE-vtable/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="Coldwinds"><meta itemprop="description" content="懒狗一只, "></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="冷风喧嚣"></span><div class="body md" itemprop="articleBody"><h1 id="io_file"><a class="anchor" href="#io_file">#</a> IO_FILE</h1><h2 id="结构体及部分函数源码分析"><a class="anchor" href="#结构体及部分函数源码分析">#</a> 结构体及部分函数源码分析</h2><h3 id="file结构体"><a class="anchor" href="#file结构体">#</a> FILE 结构体</h3><p>FILE 结构定义在 libio.h 中</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">_IO_FILE</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token keyword">int</span> _flags<span class="token punctuation">;</span>		<span class="token comment">/* High-order word is _IO_MAGIC; rest is flags. */</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_IO_file_flags</span> <span class="token expression">_flags</span></span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token comment">/* The following pointers correspond to the C++ streambuf protocol. */</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token comment">/* Note:  Tk uses the _IO_read_ptr and _IO_read_end fields directly. */</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token keyword">char</span><span class="token operator">*</span> _IO_read_ptr<span class="token punctuation">;</span>	<span class="token comment">/* Current read pointer */</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token keyword">char</span><span class="token operator">*</span> _IO_read_end<span class="token punctuation">;</span>	<span class="token comment">/* End of get area. */</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token keyword">char</span><span class="token operator">*</span> _IO_read_base<span class="token punctuation">;</span>	<span class="token comment">/* Start of putback+get area. */</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token keyword">char</span><span class="token operator">*</span> _IO_write_base<span class="token punctuation">;</span>	<span class="token comment">/* Start of put area. */</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token keyword">char</span><span class="token operator">*</span> _IO_write_ptr<span class="token punctuation">;</span>	<span class="token comment">/* Current put pointer. */</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token keyword">char</span><span class="token operator">*</span> _IO_write_end<span class="token punctuation">;</span>	<span class="token comment">/* End of put area. */</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token keyword">char</span><span class="token operator">*</span> _IO_buf_base<span class="token punctuation">;</span>	<span class="token comment">/* Start of reserve area. */</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token keyword">char</span><span class="token operator">*</span> _IO_buf_end<span class="token punctuation">;</span>	<span class="token comment">/* End of reserve area. */</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token comment">/* The following fields are used to support backing up and undo. */</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token keyword">char</span> <span class="token operator">*</span>_IO_save_base<span class="token punctuation">;</span> <span class="token comment">/* Pointer to start of non-current get area. */</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token keyword">char</span> <span class="token operator">*</span>_IO_backup_base<span class="token punctuation">;</span>  <span class="token comment">/* Pointer to first valid character of backup area */</span></pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token keyword">char</span> <span class="token operator">*</span>_IO_save_end<span class="token punctuation">;</span> <span class="token comment">/* Pointer to end of non-current get area. */</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token keyword">struct</span> <span class="token class-name">_IO_marker</span> <span class="token operator">*</span>_markers<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token keyword">struct</span> <span class="token class-name">_IO_FILE</span> <span class="token operator">*</span>_chain<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre>  <span class="token keyword">int</span> _fileno<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token number">0</span></span></span></pre></td></tr><tr><td data-num="26"></td><td><pre>  <span class="token keyword">int</span> _blksize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span></pre></td></tr><tr><td data-num="28"></td><td><pre>  <span class="token keyword">int</span> _flags2<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr><tr><td data-num="30"></td><td><pre>  _IO_off_t _old_offset<span class="token punctuation">;</span> <span class="token comment">/* This used to be _offset but it's too small.  */</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__HAVE_COLUMN</span> <span class="token comment">/* temporary */</span></span></pre></td></tr><tr><td data-num="33"></td><td><pre>  <span class="token comment">/* 1+column number of pbase(); 0 is unknown. */</span></pre></td></tr><tr><td data-num="34"></td><td><pre>  <span class="token keyword">unsigned</span> <span class="token keyword">short</span> _cur_column<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>  <span class="token keyword">signed</span> <span class="token keyword">char</span> _vtable_offset<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>  <span class="token keyword">char</span> _shortbuf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre></pre></td></tr><tr><td data-num="38"></td><td><pre>  <span class="token comment">/*  char* _save_gptr;  char* _save_egptr; */</span></pre></td></tr><tr><td data-num="39"></td><td><pre></pre></td></tr><tr><td data-num="40"></td><td><pre>  _IO_lock_t <span class="token operator">*</span>_lock<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">_IO_USE_OLD_IO_FILE</span></span></pre></td></tr><tr><td data-num="42"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>_IO_FILE 结构外包裹着另一种结构_IO_FILE_plus，在这个结构体中还包含着一个_IO_jump_t 类型的指针<strong> vtable</strong>。</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//_IO_jump_t 结构体源码:</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">_IO_jump_t</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">,</span> __dummy<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">,</span> __dummy2<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>_IO_finish_t<span class="token punctuation">,</span> __finish<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>_IO_overflow_t<span class="token punctuation">,</span> __overflow<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>_IO_underflow_t<span class="token punctuation">,</span> __underflow<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>_IO_underflow_t<span class="token punctuation">,</span> __uflow<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>_IO_pbackfail_t<span class="token punctuation">,</span> __pbackfail<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token comment">/* showmany */</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>_IO_xsputn_t<span class="token punctuation">,</span> __xsputn<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>_IO_xsgetn_t<span class="token punctuation">,</span> __xsgetn<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>_IO_seekoff_t<span class="token punctuation">,</span> __seekoff<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>_IO_seekpos_t<span class="token punctuation">,</span> __seekpos<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>_IO_setbuf_t<span class="token punctuation">,</span> __setbuf<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>_IO_sync_t<span class="token punctuation">,</span> __sync<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>_IO_doallocate_t<span class="token punctuation">,</span> __doallocate<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>_IO_read_t<span class="token punctuation">,</span> __read<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>_IO_write_t<span class="token punctuation">,</span> __write<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>_IO_seek_t<span class="token punctuation">,</span> __seek<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>_IO_close_t<span class="token punctuation">,</span> __close<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>_IO_stat_t<span class="token punctuation">,</span> __stat<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>_IO_showmanyc_t<span class="token punctuation">,</span> __showmanyc<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>_IO_imbue_t<span class="token punctuation">,</span> __imbue<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token number">0</span></span></span></pre></td></tr><tr><td data-num="27"></td><td><pre>    get_column<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    set_column<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="33"></td><td><pre></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token comment">//_IO_FILE_plus 及 vtable 指针定义:</span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">_IO_FILE_plus</span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>  _IO_FILE file<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>  <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">_IO_jump_t</span> <span class="token operator">*</span>vtable<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr></table></figure><p>在_IO_jump_t 结构体中包含了一系列指针，在调用 fopen、fclose、fread 等一系列函数时就会调用这些函数指针</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span> <span class="token operator">*</span> funcs<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>   <span class="token number">1</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token comment">// "extra word"</span></pre></td></tr><tr><td data-num="3"></td><td><pre>   <span class="token number">2</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token comment">// DUMMY</span></pre></td></tr><tr><td data-num="4"></td><td><pre>   <span class="token number">3</span> exit<span class="token punctuation">,</span> <span class="token comment">// finish</span></pre></td></tr><tr><td data-num="5"></td><td><pre>   <span class="token number">4</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token comment">// overflow</span></pre></td></tr><tr><td data-num="6"></td><td><pre>   <span class="token number">5</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token comment">// underflow</span></pre></td></tr><tr><td data-num="7"></td><td><pre>   <span class="token number">6</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token comment">// uflow</span></pre></td></tr><tr><td data-num="8"></td><td><pre>   <span class="token number">7</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token comment">// pbackfail</span></pre></td></tr><tr><td data-num="9"></td><td><pre>   <span class="token number">8</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token comment">// xsputn  #printf</span></pre></td></tr><tr><td data-num="10"></td><td><pre>   <span class="token number">9</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token comment">// xsgetn</span></pre></td></tr><tr><td data-num="11"></td><td><pre>   <span class="token number">10</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token comment">// seekoff</span></pre></td></tr><tr><td data-num="12"></td><td><pre>   <span class="token number">11</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token comment">// seekpos</span></pre></td></tr><tr><td data-num="13"></td><td><pre>   <span class="token number">12</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token comment">// setbuf</span></pre></td></tr><tr><td data-num="14"></td><td><pre>   <span class="token number">13</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token comment">// sync</span></pre></td></tr><tr><td data-num="15"></td><td><pre>   <span class="token number">14</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token comment">// doallocate</span></pre></td></tr><tr><td data-num="16"></td><td><pre>   <span class="token number">15</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token comment">// read</span></pre></td></tr><tr><td data-num="17"></td><td><pre>   <span class="token number">16</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token comment">// write</span></pre></td></tr><tr><td data-num="18"></td><td><pre>   <span class="token number">17</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token comment">// seek</span></pre></td></tr><tr><td data-num="19"></td><td><pre>   <span class="token number">18</span> pwn<span class="token punctuation">,</span>  <span class="token comment">// close</span></pre></td></tr><tr><td data-num="20"></td><td><pre>   <span class="token number">19</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token comment">// stat</span></pre></td></tr><tr><td data-num="21"></td><td><pre>   <span class="token number">20</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token comment">// showmanyc</span></pre></td></tr><tr><td data-num="22"></td><td><pre>   <span class="token number">21</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token comment">// imbue</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>可以通过gdb打印来查看vtable中的指针：</pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre>pwndbg<span class="token operator">></span> print _IO_file_jumps</pre></td></tr><tr><td data-num="4"></td><td><pre>$<span class="token number">1</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  __dummy <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  __dummy2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  __finish <span class="token operator">=</span> <span class="token number">0x7ffff7e540d0</span> <span class="token operator">&lt;</span>_IO_new_file_finish<span class="token operator">></span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  __overflow <span class="token operator">=</span> <span class="token number">0x7ffff7e54f00</span> <span class="token operator">&lt;</span>_IO_new_file_overflow<span class="token operator">></span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  __underflow <span class="token operator">=</span> <span class="token number">0x7ffff7e54ba0</span> <span class="token operator">&lt;</span>_IO_new_file_underflow<span class="token operator">></span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  __uflow <span class="token operator">=</span> <span class="token number">0x7ffff7e560d0</span> <span class="token operator">&lt;</span>__GI__IO_default_uflow<span class="token operator">></span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  __pbackfail <span class="token operator">=</span> <span class="token number">0x7ffff7e57800</span> <span class="token operator">&lt;</span>__GI__IO_default_pbackfail<span class="token operator">></span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  __xsputn <span class="token operator">=</span> <span class="token number">0x7ffff7e53750</span> <span class="token operator">&lt;</span>_IO_new_file_xsputn<span class="token operator">></span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  __xsgetn <span class="token operator">=</span> <span class="token number">0x7ffff7e533c0</span> <span class="token operator">&lt;</span>__GI__IO_file_xsgetn<span class="token operator">></span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  __seekoff <span class="token operator">=</span> <span class="token number">0x7ffff7e529e0</span> <span class="token operator">&lt;</span>_IO_new_file_seekoff<span class="token operator">></span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  __seekpos <span class="token operator">=</span> <span class="token number">0x7ffff7e56780</span> <span class="token operator">&lt;</span>_IO_default_seekpos<span class="token operator">></span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  __setbuf <span class="token operator">=</span> <span class="token number">0x7ffff7e526b0</span> <span class="token operator">&lt;</span>_IO_new_file_setbuf<span class="token operator">></span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  __sync <span class="token operator">=</span> <span class="token number">0x7ffff7e52540</span> <span class="token operator">&lt;</span>_IO_new_file_sync<span class="token operator">></span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="18"></td><td><pre>  __doallocate <span class="token operator">=</span> <span class="token number">0x7ffff7e45df0</span> <span class="token operator">&lt;</span>__GI__IO_file_doallocate<span class="token operator">></span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  __read <span class="token operator">=</span> <span class="token number">0x7ffff7e53720</span> <span class="token operator">&lt;</span>__GI__IO_file_read<span class="token operator">></span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="20"></td><td><pre>  __write <span class="token operator">=</span> <span class="token number">0x7ffff7e52fe0</span> <span class="token operator">&lt;</span>_IO_new_file_write<span class="token operator">></span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="21"></td><td><pre>  __seek <span class="token operator">=</span> <span class="token number">0x7ffff7e52780</span> <span class="token operator">&lt;</span>__GI__IO_file_seek<span class="token operator">></span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="22"></td><td><pre>  __close <span class="token operator">=</span> <span class="token number">0x7ffff7e526a0</span> <span class="token operator">&lt;</span>__GI__IO_file_close<span class="token operator">></span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="23"></td><td><pre>  __stat <span class="token operator">=</span> <span class="token number">0x7ffff7e52fc0</span> <span class="token operator">&lt;</span>__GI__IO_file_stat<span class="token operator">></span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="24"></td><td><pre>  __showmanyc <span class="token operator">=</span> <span class="token number">0x7ffff7e57990</span> <span class="token operator">&lt;</span>_IO_default_showmanyc<span class="token operator">></span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="25"></td><td><pre>  __imbue <span class="token operator">=</span> <span class="token number">0x7ffff7e579a0</span> <span class="token operator">&lt;</span>_IO_default_imbue<span class="token operator">></span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>当程序执行 fopen 等函数时就会创建 FILE 结构体，当我们打开多个文件，就会创建多个 FILE 结构体，这时候这些 FILE 结构体就会通过_chain 域相连，链表头部用全局变量_IO_list_all 表示，</p><p>当程序启动时会打开三个文件流：stdin、stdout、stderr。在初始状态下，_IO_list_all 指向的是一个有这些文件流构成的链表，但是需要注意的是这三个文件流位于 libc.so 的数据段。而我们使用 fopen 创建的文件流是分配在堆内存上的。</p><h3 id="fopen"><a class="anchor" href="#fopen">#</a> fopen</h3><p>fopen 用于打开文件，原型如下：</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>FILE <span class="token operator">*</span><span class="token function">fopen</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>filename<span class="token punctuation">,</span> <span class="token operator">*</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">// 返回一个文件指针</span></pre></td></tr></table></figure><p>fopen 函数实际调用的是_IO_new_fopen 函数，_IO_new_fopen 函数又会调用_fopen_internal 函数，__fopen_internal 函数主要分为四步：</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token number">1.</span>malloc分配内存空间。</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">2.</span>调用_IO_no_init函数对file结构体进行null初始化。</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">3.</span>调用_IO_file_init函数将结构体链接进_IO_list_all链表。</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token number">4.</span>调用_IO_file_fopen函数最终执行系统调用打开文件。</pre></td></tr></table></figure><h3 id="fread"><a class="anchor" href="#fread">#</a> fread</h3><p>fread 从文件流中读取数据，原型如下：</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">_IO_fread</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> _IO_size_t size<span class="token punctuation">,</span> _IO_size_t count<span class="token punctuation">,</span> _IO_FILE <span class="token operator">*</span>fp<span class="token punctuation">)</span></pre></td></tr></table></figure><p>fread 函数实际调用的是_IO_fread 函数，_IO_fread 函数又调用_IO_sgetn 函数，这个函数又继续调用_IO_XSGETN 函数，其实就是 vtable 中的__xsgetn 函数。</p><p>__xsgetn 函数主要分为三步：</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token number">1.</span>当fp<span class="token operator">-></span>_IO_buf_base<span class="token operator">==</span><span class="token constant">NULL</span>时，说明FILE结构体中的指针还没有被初始化，缓冲区未建立，则调用_IO_doallocbuf初始化指针，建立缓冲区。</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">2.</span>当输入缓冲区里有数据，即fp<span class="token operator">-></span>_IO_read_ptr小于fp<span class="token operator">-></span>_IO_read_end时，把缓冲区里的数据直接拷贝至目标buf。</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">3.</span>当缓冲区里的数据为空或者是不能满足全部的需求，则调用__underflow调用系统调用读入数据。</pre></td></tr></table></figure><p>fread 在执行系统调用前执行了多次 vtable 中的函数。</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>__GI__IO_file_xsgetn</pre></td></tr><tr><td data-num="2"></td><td><pre>_IO_file_doallocate  <span class="token comment">// 初始化输入缓冲区</span></pre></td></tr><tr><td data-num="3"></td><td><pre>__GI__IO_file_stat  <span class="token comment">// 获取文件信息</span></pre></td></tr><tr><td data-num="4"></td><td><pre>_IO_new_file_underflow  <span class="token comment">// 读取文件数据</span></pre></td></tr><tr><td data-num="5"></td><td><pre>__GI__IO_file_read  <span class="token comment">// 最终执行系统调用</span></pre></td></tr></table></figure><h3 id="fwrite"><a class="anchor" href="#fwrite">#</a> fwrite</h3><p>fwrite 向文件流中写入数据，原型如下：</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token class-name">size_t</span> <span class="token function">fwrite</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">,</span> <span class="token class-name">size_t</span> size<span class="token punctuation">,</span> <span class="token class-name">size_t</span> nmemb<span class="token punctuation">,</span>FILE <span class="token operator">*</span>stream<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>fwrite 函数实际调用的是_IO_fwrite 函数，_IO_fwrite 函数又调用了_IO_sputn 函数，即 vtable 中的__xsputn 函数。</p><p>这个函数也分为三部分：</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token number">1.</span>判断输出缓冲区还有多少空间，如果输出缓冲区有剩余空间的话，把目标输出数据拷贝到输出缓冲区，然后计算在输出缓冲区填满后，是否仍然剩余的目标输出数据。</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">2.</span>如果还有剩余的目标输出数据，说明输出缓冲区满了或者没有建立，这时候调用_IO_OVERFLOW刷新或建立输出缓冲区。</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">3.</span>经过刷新或建立输出缓冲区后，检查目标输出数据的大小，如果超出输出缓冲区的大小，就跳过输出缓冲区直接输出。然后把最后剩余的数据拷贝到输出缓冲区。</pre></td></tr></table></figure><p>fwrite 在执行系统调用前同样执行了多次 vtable 中的函数</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>_IO_new_file_xsputn</pre></td></tr><tr><td data-num="2"></td><td><pre>_IO_new_file_overflow  <span class="token comment">// 刷新或建立输出缓冲区</span></pre></td></tr><tr><td data-num="3"></td><td><pre>_IO_file_doallocate  <span class="token comment">// 初始化输入缓冲区</span></pre></td></tr><tr><td data-num="4"></td><td><pre>__GI__IO_file_stat  <span class="token comment">// 获取文件信息</span></pre></td></tr><tr><td data-num="5"></td><td><pre>_IO_new_file_write  <span class="token comment">// 最终执行系统调用</span></pre></td></tr></table></figure><h3 id="fclose"><a class="anchor" href="#fclose">#</a> fclose</h3><p>fclose 用于关闭已打开的文件，原型如下：</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">int</span> <span class="token function">fclose</span><span class="token punctuation">(</span>FILE <span class="token operator">*</span>stream<span class="token punctuation">)</span></pre></td></tr></table></figure><p>执行 fclose 后会关闭一个文件流，把缓冲区内剩余的数据输出到文件中，同时释放文件指针和有关的缓冲区。</p><p>fclose 函数实际调用的是_IO_new_fclose 函数，_IO_new_fclose 函数大致分为四部分：</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token number">1.</span>调用_IO_un_link函数将IO FILE结构体从_IO_list_all链表中取下。</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">2.</span>调用_IO_file_close_it函数关闭文件，释放缓冲区，并清空缓冲区指针。</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">3.</span>调用_IO_FINISH函数，即vtable中的__finish函数，确认文件开关状态和缓冲区是否被释放。</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token number">4.</span>此时已经将结构体从链表中删除，刷新了缓冲区，释放了缓冲区内存，只剩下结构体内存尚未释放，因此释放结构体内存。</pre></td></tr></table></figure><p>fclose 函数执行过程中调用的 vtable 函数</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>__close  <span class="token comment">// 执行系统调用关闭文件描述符</span></pre></td></tr><tr><td data-num="2"></td><td><pre>__finish  <span class="token comment">// 确认文件开关状态和缓冲区状态</span></pre></td></tr></table></figure><h3 id="部分函数在libc中的函数名"><a class="anchor" href="#部分函数在libc中的函数名">#</a> 部分函数在 libc 中的函数名：</h3><blockquote><p>p *(struct _IO_FILE_plus *) stdout</p><p>p *_IO_list_all</p><p>p _IO_file_jumps</p><p>_IO_new_file_init</p><p>_IO_new_file_fopen</p><p>_IO_file_open</p><p>_IO_file_xsgetn</p><p>_IO_new_file_xsputn</p><p>_IO_new_file_close_it</p></blockquote><h2 id="劫持vtable并修改指针"><a class="anchor" href="#劫持vtable并修改指针">#</a> 劫持 vtable 并修改指针</h2><p>vtable 是_IO_FILE_plus 结构体里的一个字段，是一个函数表指针，里面存储着许多和 IO 相关的函数。</p><p>fread、fwrite、fclose 等 IO 函数基本都调用了 vtable 中的函数来实现功能。</p><h3 id="223"><a class="anchor" href="#223">#</a> 2.23</h3><h4 id="vtable劫持原理"><a class="anchor" href="#vtable劫持原理">#</a> vtable 劫持原理：</h4><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>控制FILE结构体，实现对vtable指针的修改，使得vtable指向可控的内存，在该内存中构造好vtable，再通过调用相应IO函数，触发vtable函数的调用，即可劫持程序执行流。</pre></td></tr></table></figure><h4 id="思路"><a class="anchor" href="#思路">#</a> 思路：</h4><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token number">1.</span>修改内存中已有FILE结构体的vtable字段。</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">2.</span>伪造整个FILE结构体。</pre></td></tr><tr><td data-num="3"></td><td><pre>本质都是修改了vtable字段。</pre></td></tr></table></figure><h4 id="例子"><a class="anchor" href="#例子">#</a> 例子</h4><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">system_ptr</span> <span class="token expression"><span class="token number">0x7ffff7a52390</span><span class="token punctuation">;</span></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdlib.h></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;string.h></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre> FILE <span class="token operator">*</span>fp<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre> <span class="token keyword">long</span> <span class="token keyword">long</span> <span class="token operator">*</span>vtable_addr<span class="token punctuation">,</span><span class="token operator">*</span>fake_vtable<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre> fp<span class="token operator">=</span><span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string">"123.txt"</span><span class="token punctuation">,</span><span class="token string">"rw"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre> fake_vtable<span class="token operator">=</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x40</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 开辟一个堆当作伪造的 vtable。</span></pre></td></tr><tr><td data-num="12"></td><td><pre> vtable_addr<span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token keyword">long</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token keyword">long</span><span class="token punctuation">)</span>fp<span class="token operator">+</span><span class="token number">0xd8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//0xd8 为 64 位下 vtable 在_IO_FILE_plus 结构体中的偏移。</span></pre></td></tr><tr><td data-num="13"></td><td><pre> vtable_addr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token keyword">long</span><span class="token punctuation">)</span>fake_vtable<span class="token punctuation">;</span><span class="token comment">// 让 vtable 指针指向我们伪造的 vtable。</span></pre></td></tr><tr><td data-num="14"></td><td><pre> <span class="token function">memcpy</span><span class="token punctuation">(</span>fp<span class="token punctuation">,</span><span class="token string">"sh"</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 因为 vtable 中的函数调用时会把对应的_IO_FILE_plus 指针作为第一个参数传递，也就是_flags 成员变量，所以这里设置_flag="sh"。</span></pre></td></tr><tr><td data-num="15"></td><td><pre> fake_vtable<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token operator">=</span>system_ptr<span class="token punctuation">;</span> <span class="token comment">// 找到__xsputn 函数在 vtable 中的偏移，修改这个位置的指针，使其指向 system 函数。</span></pre></td></tr><tr><td data-num="16"></td><td><pre> <span class="token function">fwrite</span><span class="token punctuation">(</span><span class="token string">"hi"</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 执行 fwrite 函数会调用__xsputn 函数，实际上是执行 system ("sh")</span></pre></td></tr><tr><td data-num="17"></td><td><pre> <span class="token function">fclose</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="224以后"><a class="anchor" href="#224以后">#</a> 2.24 以后</h3><h4 id="vtable-check机制"><a class="anchor" href="#vtable-check机制">#</a> vtable check 机制</h4><p>在执行_IO_OVERFLOW 函数前执行了 IO_validate_vtable 函数，这个函数会检测 vtable 是不是 glibc 中的 vtable，如果不是，进入_IO_vtable_check 函数。</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">_IO_vtable_check</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">SHARED</span></span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token comment">/* Honor the compatibility flag.  */</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>flag<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">atomic_load_relaxed</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>IO_accept_foreign_vtables<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">PTR_DEMANGLE</span></span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token function">PTR_DEMANGLE</span> <span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>flag <span class="token operator">==</span> <span class="token operator">&amp;</span>_IO_vtable_check<span class="token punctuation">)</span>   <span class="token comment">// 检查是不是外部构造中的 vtable</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    Dl_info di<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">struct</span> <span class="token class-name">link_map</span> <span class="token operator">*</span>l<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>_dl_open_hook <span class="token operator">!=</span> <span class="token constant">NULL</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token function">_dl_addr</span> <span class="token punctuation">(</span>_IO_vtable_check<span class="token punctuation">,</span> <span class="token operator">&amp;</span>di<span class="token punctuation">,</span> <span class="token operator">&amp;</span>l<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="16"></td><td><pre>            <span class="token operator">&amp;&amp;</span> l<span class="token operator">-></span>l_ns <span class="token operator">!=</span> LM_ID_BASE<span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment">// 检查是不是动态链接库的 vtable</span></pre></td></tr><tr><td data-num="17"></td><td><pre>      <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span> <span class="token comment">/* !SHARED */</span></span></pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>__dlopen <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr><tr><td data-num="23"></td><td><pre>  <span class="token function">__libc_fatal</span> <span class="token punctuation">(</span><span class="token string">"Fatal error: glibc detected an invalid stdio handle\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>  <span class="token comment">// 如果都不是，就报错，并且结束程序</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>总结：</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token number">1.</span>判断vtable的地址是否位于glibc中的vtable数据段，若是，通过检查，返回。</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">2.</span>判断vtable是否为外部合法的<span class="token function">vtable</span><span class="token punctuation">(</span>通过FILE<span class="token operator">*</span>结构体创建的vtable等<span class="token punctuation">)</span>，若是，通过检查，返回。</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">3.</span>若前两项检查都不通过，报错，退出程序。</pre></td></tr></table></figure><p>有了这个机制后，我们伪造的 vtable 本身就位于堆栈上，肯定会进入_IO_vtable_check 函数检查，并且修改 vtable 指针的行为通过不了这个检查，最终报错。</p><h4 id="绕过vtable-check机制"><a class="anchor" href="#绕过vtable-check机制">#</a> 绕过 vtable check 机制</h4><h5 id="vtable覆盖为外部地址"><a class="anchor" href="#vtable覆盖为外部地址">#</a> vtable 覆盖为外部地址</h5><p>因为 check 机制的存在，我们如果还想伪造 vtable，就需要满足下面两个条件的其中一个，分别对应_IO_vtable_check 函数的两次检查条件。</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token number">1</span>、flag <span class="token operator">==</span> <span class="token operator">&amp;</span>_IO_vtable_check</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">2</span>、_dl_open_hook<span class="token operator">!=</span> <span class="token constant">NULL</span></pre></td></tr></table></figure><p>第一个条件，flag 的生成与 canary 类似，并没有固定的值，想要让 flag == &amp;_IO_vtable_check 是比较困难的。</p><p>第二个条件，如果能往_dl_open_hook 中写值，那完全可以往其他 hook 中写值，有更简单的方法。</p><h5 id="利用另一个vtable函数_io_str_jumps"><a class="anchor" href="#利用另一个vtable函数_io_str_jumps">#</a> 利用另一个 vtable 函数（_IO_str_jumps）</h5><blockquote><p>p _IO_str_jumps</p></blockquote><p>这个 vtable 中有两个函数，_IO_str_overflow 和_IO_str_finish。其中_IO_str_finish 函数在满足 if 语句的情况下直接使用了 fp-&gt;_s._free_buffer 指针，如果修改这个指针为 one_gadget，就能 getshell。</p><h6 id="如何利用"><a class="anchor" href="#如何利用">#</a> 如何利用</h6><ol><li><p>绕过_IO_flush_all_lokcp 中对输出缓冲区的检查，让程序进入_IO_OVERFLOW 函数。</p></li><li><p>要绕过 vtable check 机制，可以把 vtable 的地址覆盖成_IO_str_jumps-8 的地址（_IO_str_jumps 的偏移为 0x10，_IO_OVERFLOW 的偏移为 0x18），_IO_str_finish 函数成为了伪造的 vtable 地址的_IO_OVERFLOW 函数，同时因为_IO_str_finish 函数位于 vtable 的地址段中，所以可以绕过 vtable check。_</p></li><li><p>_满足_IO_str_finish 函数的 if 语句，让程序使用 fp-&gt;_s._free_buffer 指针。因此要满足 fp-&gt;_IO_buf_base 不为 NULL 并且 fp-&gt;_flags 中不包含_IO_USER_BUF。（#define _IO_USER_BUF 1;）</p></li><li><p>构造 fp-&gt;_s._free_buffer 为 system/gadget，fp-&gt;_IO_buf_base 为 &quot;/bin/sh&quot;，调用 (((_IO_strfile *) fp)-&gt;_s._free_buffer) (fp-&gt;_IO_buf_base) 时就相当于执行了 system (&quot;/bin/sh&quot;)。</p></li></ol><h2 id="劫持vtable及fsop"><a class="anchor" href="#劫持vtable及fsop">#</a> 劫持 vtable 及 FSOP</h2><p>FSOP 全称是 <code>File Stream Oriented Programming</code> ，利用的是前面 <code>fopen</code> 函数中描述过的 <code>_IO_list_all</code> 指针。</p><p>我们知道程序中所有打开的文件流都是由一个单链表进行管理的，并且，链表是由结构体中的_chain 字段进行连接。</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>在正常的程序中，会存在<span class="token constant">stderr</span>、<span class="token constant">stdout</span>、<span class="token constant">stdin</span>三个IO_FILE，通过gdb打印</pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre>pwndbg<span class="token operator">></span> print _IO_list_all</pre></td></tr><tr><td data-num="4"></td><td><pre>$<span class="token number">1</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> \_IO\_FILE\_plus <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token number">0x7ffff7dd2540</span> <span class="token operator">&lt;</span>\_IO\_2\_1\_stderr\_<span class="token operator">></span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>pwndbg<span class="token operator">></span> print _IO_list_all<span class="token operator">-></span>file<span class="token punctuation">.</span>_chain</pre></td></tr><tr><td data-num="7"></td><td><pre>$<span class="token number">2</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> \_IO\_FILE <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token number">0x7ffff7dd2620</span> <span class="token operator">&lt;</span>\_IO\_2\_1_stdout\_<span class="token operator">></span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>pwndbg<span class="token operator">></span> <span class="token function">print</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">_IO_FILE</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>_IO_list_all<span class="token operator">-></span>file<span class="token punctuation">.</span>_chain<span class="token punctuation">)</span><span class="token punctuation">.</span>_chain</pre></td></tr><tr><td data-num="10"></td><td><pre>$<span class="token number">3</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> \_IO\_FILE <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token number">0x7ffff7dd18e0</span> <span class="token operator">&lt;</span>\_IO\_2\_1\_stdin\_<span class="token operator">></span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>pwndbg<span class="token operator">></span> <span class="token function">print</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">_IO_FILE</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>_IO_list_all<span class="token operator">-></span>file<span class="token punctuation">.</span>_chain<span class="token punctuation">)</span><span class="token punctuation">.</span>_chain<span class="token punctuation">)</span><span class="token punctuation">.</span>_chain</pre></td></tr><tr><td data-num="13"></td><td><pre>$<span class="token number">4</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> \_IO\_FILE <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token number">0x0</span></pre></td></tr></table></figure><p>形成了下图所示的链表：</p><p><img data-src="https://raw.githubusercontent.com/ray-cp/ray-cp.github.io/master/_img/2019-07-04-IO_FILE_vtable_hajack_and_fsop/1557891223351.png" alt="Alt text"></p><p>如果能够控制 <code>_IO_list_all</code> 指针，就可以让该指针直接指向我们想要的地址，这就是 FSOP。</p><p>libc 中存在一个函数 <code>_IO_flush_all_lockp</code> ，用来刷新所 有 FILE 结构体的输出缓冲区。</p><figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">int</span> <span class="token function">_IO_flush_all_lockp</span> <span class="token punctuation">(</span><span class="token keyword">int</span> do_lock<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token keyword">struct</span> <span class="token class-name">_IO_FILE</span> <span class="token operator">*</span>fp<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token keyword">int</span> last_stamp<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">_IO_MTSAFE_IO</span></span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token function">__libc_cleanup_region_start</span> <span class="token punctuation">(</span>do_lock<span class="token punctuation">,</span> flush_cleanup<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>do_lock<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token function">_IO_lock_lock</span> <span class="token punctuation">(</span>list_all_lock<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>  last_stamp <span class="token operator">=</span> _IO_list_all_stamp<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  fp <span class="token operator">=</span> <span class="token punctuation">(</span>_IO_FILE <span class="token operator">*</span><span class="token punctuation">)</span> _IO_list_all<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token keyword">while</span> <span class="token punctuation">(</span>fp <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>      run_fp <span class="token operator">=</span> fp<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>do_lock<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="19"></td><td><pre>	<span class="token function">_IO_flockfile</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>fp<span class="token operator">-></span>_mode <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> fp<span class="token operator">-></span>_IO_write_ptr <span class="token operator">></span> fp<span class="token operator">-></span>_IO_write_base<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">defined _LIBC <span class="token operator">||</span> defined _GLIBCPP_USE_WCHAR_T</span></span></pre></td></tr><tr><td data-num="23"></td><td><pre>	   <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token function">_IO_vtable_offset</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="24"></td><td><pre>	       <span class="token operator">&amp;&amp;</span> fp<span class="token operator">-></span>_mode <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_wide_data<span class="token operator">-></span>_IO_write_ptr</pre></td></tr><tr><td data-num="25"></td><td><pre>				    <span class="token operator">></span> fp<span class="token operator">-></span>_wide_data<span class="token operator">-></span>_IO_write_base<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr><tr><td data-num="27"></td><td><pre>	   <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="28"></td><td><pre>	  <span class="token operator">&amp;&amp;</span> <span class="token function">_IO_OVERFLOW</span> <span class="token punctuation">(</span>fp<span class="token punctuation">,</span> <span class="token constant">EOF</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">EOF</span><span class="token punctuation">)</span>     <span class="token comment">// 如果缓冲区还有数据，就刷新数据缓冲区</span></pre></td></tr><tr><td data-num="29"></td><td><pre>	result <span class="token operator">=</span> <span class="token constant">EOF</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>do_lock<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="32"></td><td><pre>	<span class="token function">_IO_funlockfile</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>      run_fp <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre></pre></td></tr><tr><td data-num="35"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>last_stamp <span class="token operator">!=</span> _IO_list_all_stamp<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="36"></td><td><pre>	<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>	  <span class="token comment">/* Something was added to the list.  Start all over again.  */</span></pre></td></tr><tr><td data-num="38"></td><td><pre>	  fp <span class="token operator">=</span> <span class="token punctuation">(</span>_IO_FILE <span class="token operator">*</span><span class="token punctuation">)</span> _IO_list_all<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>	  last_stamp <span class="token operator">=</span> _IO_list_all_stamp<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>      <span class="token keyword">else</span></pre></td></tr><tr><td data-num="42"></td><td><pre>	fp <span class="token operator">=</span> fp<span class="token operator">-></span>_chain<span class="token punctuation">;</span>        <span class="token comment">// 遍历列表，检查所有结构体的输出缓冲区。</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="44"></td><td><pre></pre></td></tr><tr><td data-num="45"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">_IO_MTSAFE_IO</span></span></pre></td></tr><tr><td data-num="46"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>do_lock<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token function">_IO_lock_unlock</span> <span class="token punctuation">(</span>list_all_lock<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>  <span class="token function">__libc_cleanup_region_end</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr><tr><td data-num="50"></td><td><pre></pre></td></tr><tr><td data-num="51"></td><td><pre>  <span class="token keyword">return</span> result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>前面在分析 fwrite 的时候提到过，输出缓冲区的数据保存在 <code>fp-&gt;IO_write_base</code> 上，且长度为 <code>fp-&gt;_IO_write_ptr-fp-&gt;_IO_write_base</code> ，因此，这个函数的整体思路是检查该结构体的输出缓冲区是否还有数据，如果有就调用 <code>_IO_OVERFLOW</code> 去刷新输出缓冲区。如果可以控制 <code>_IO_list_all</code> 中的某一个节点，并构造 vtable 的话，就可以控制程序流。</p><p>攻击的整体流程就是：</p><blockquote><ol><li>伪造一个 <code>_IO_FILE</code> 结构体，并使 <code>_IO_list_all</code> 链表指向该结构体，或者让 <code>_IO_list_all</code> 链表中某一节点的 <code>_chain</code> 字段指向伪造的数据。</li><li>利用 <code>_IO_flush_all_lockp</code> 函数，绕过检查，最终调用 <code>_IO_OVERFLOW</code> 来劫持程序流。</li></ol></blockquote><h3 id="东华杯2016-pwn450-notehouse-of-orange"><a class="anchor" href="#东华杯2016-pwn450-notehouse-of-orange">#</a> 东华杯 2016-pwn450-note（house of orange）</h3><p>待施工。。。</p><div class="tags"><a href="/tags/pwn/" rel="tag"><i class="ic i-tag"></i> pwn</a> <a href="/tags/IO-FILE/" rel="tag"><i class="ic i-tag"></i> IO_FILE</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">更新于</span> <time title="修改时间：2021-12-13 17:29:57" itemprop="dateModified" datetime="2021-12-13T17:29:57+08:00">2021-12-13</time></span></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>Coldwinds <i class="ic i-at"><em>@</em></i>冷风喧嚣</li><li class="link"><strong>本文链接：</strong> <a href="https://www.coldwinds.top/2021/12/IO-FILE-vtable/" title="IO_FILE介绍及vtable劫持">https://www.coldwinds.top/2021/12/IO-FILE-vtable/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/2021/12/web-start/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;tva2.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1gicliierfjj20zk0m8npd.jpg" title="Web学习方向"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i></span><h3>Web学习方向</h3></a></div><div class="item right"><a href="/2022/03/2019-qwb-babybank/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;tva2.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1giclffsa1cj20zk0m811l.jpg" title="2019-强网杯-babybank"><span class="type">下一篇</span> <span class="category"><i class="ic i-flag"></i></span><h3>2019-强网杯-babybank</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#io_file"><span class="toc-number">1.</span> <span class="toc-text">IO_FILE</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%93%E6%9E%84%E4%BD%93%E5%8F%8A%E9%83%A8%E5%88%86%E5%87%BD%E6%95%B0%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">1.1.</span> <span class="toc-text">结构体及部分函数源码分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#file%E7%BB%93%E6%9E%84%E4%BD%93"><span class="toc-number">1.1.1.</span> <span class="toc-text">FILE 结构体</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fopen"><span class="toc-number">1.1.2.</span> <span class="toc-text">fopen</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fread"><span class="toc-number">1.1.3.</span> <span class="toc-text">fread</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fwrite"><span class="toc-number">1.1.4.</span> <span class="toc-text">fwrite</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fclose"><span class="toc-number">1.1.5.</span> <span class="toc-text">fclose</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%83%A8%E5%88%86%E5%87%BD%E6%95%B0%E5%9C%A8libc%E4%B8%AD%E7%9A%84%E5%87%BD%E6%95%B0%E5%90%8D"><span class="toc-number">1.1.6.</span> <span class="toc-text">部分函数在 libc 中的函数名：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%AB%E6%8C%81vtable%E5%B9%B6%E4%BF%AE%E6%94%B9%E6%8C%87%E9%92%88"><span class="toc-number">1.2.</span> <span class="toc-text">劫持 vtable 并修改指针</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#223"><span class="toc-number">1.2.1.</span> <span class="toc-text">2.23</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#vtable%E5%8A%AB%E6%8C%81%E5%8E%9F%E7%90%86"><span class="toc-number">1.2.1.1.</span> <span class="toc-text">vtable 劫持原理：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF"><span class="toc-number">1.2.1.2.</span> <span class="toc-text">思路：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BE%8B%E5%AD%90"><span class="toc-number">1.2.1.3.</span> <span class="toc-text">例子</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#224%E4%BB%A5%E5%90%8E"><span class="toc-number">1.2.2.</span> <span class="toc-text">2.24 以后</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#vtable-check%E6%9C%BA%E5%88%B6"><span class="toc-number">1.2.2.1.</span> <span class="toc-text">vtable check 机制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%95%E8%BF%87vtable-check%E6%9C%BA%E5%88%B6"><span class="toc-number">1.2.2.2.</span> <span class="toc-text">绕过 vtable check 机制</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#vtable%E8%A6%86%E7%9B%96%E4%B8%BA%E5%A4%96%E9%83%A8%E5%9C%B0%E5%9D%80"><span class="toc-number">1.2.2.2.1.</span> <span class="toc-text">vtable 覆盖为外部地址</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E5%8F%A6%E4%B8%80%E4%B8%AAvtable%E5%87%BD%E6%95%B0_io_str_jumps"><span class="toc-number">1.2.2.2.2.</span> <span class="toc-text">利用另一个 vtable 函数（_IO_str_jumps）</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%88%A9%E7%94%A8"><span class="toc-number">1.2.2.2.2.1.</span> <span class="toc-text">如何利用</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%AB%E6%8C%81vtable%E5%8F%8Afsop"><span class="toc-number">1.3.</span> <span class="toc-text">劫持 vtable 及 FSOP</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%9C%E5%8D%8E%E6%9D%AF2016-pwn450-notehouse-of-orange"><span class="toc-number">1.3.1.</span> <span class="toc-text">东华杯 2016-pwn450-note（house of orange）</span></a></li></ol></li></ol></li></ol></div><div class="related panel pjax" data-title="系列文章"></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="Coldwinds" data-src="/images/avatar.jpg"><p class="name" itemprop="name">Coldwinds</p><div class="description" itemprop="description"></div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">8</span> <span class="name">文章</span></a></div><div class="item tags"><a href="/tags/"><span class="count">6</span> <span class="name">标签</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL0NvbGR3aW5kczUxNjc=" title="https:&#x2F;&#x2F;github.com&#x2F;Coldwinds5167"><i class="ic i-github"></i></span> <a href="/825592085@qq.com" title="825592085@qq.com" class="item email"><i class="ic i-envelope"></i></a></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-user"></i>关于</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-star"></i>清单</a><ul class="submenu"><li class="item"><a href="/Bangumi/" rel="section"><i class="ic i-magic"></i>番剧</a></li><li class="item"><a href="/music/" rel="section"><i class="ic i-music"></i>歌单</a></li></ul></li><li class="item"><a href="/friends/" rel="section"><i class="ic i-heart"></i>友站</a></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/2021/12/web-start/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/2022/03/2019-qwb-babybank/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"></div><span><a href="/2021/12/pwn-reserve-start/" title="二进制（pwn、reverse）学习方向">二进制（pwn、reverse）学习方向</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/2021/12/Blockchain-profiles/" title="区块链简介">区块链简介</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/2021/12/web-start/" title="Web学习方向">Web学习方向</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/2022/03/2019-qwb-babybank/" title="2019-强网杯-babybank">2019-强网杯-babybank</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/2021/12/crypto-start/" title="密码学（Crypto）学习方向">密码学（Crypto）学习方向</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/2021/12/pwn-environment/" title="pwn环境搭建">pwn环境搭建</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/2021/12/IO-FILE-vtable/" title="IO_FILE介绍及vtable劫持">IO_FILE介绍及vtable劫持</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/2021/12/Re-Entrancy/" title="重入攻击">重入攻击</a></span></li></ul></div></div><div class="status"><div class="copyright">&copy; 2010 – <span itemprop="copyrightYear">2022</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">Coldwinds @ Coldwinds</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="站点总字数">49k 字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="站点阅读时长">44 分钟</span></div><div class="powered-by">基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"2021/12/IO-FILE-vtable/",favicon:{show:"欢迎回来~",hide:"网页消失啦~"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script></body></html>